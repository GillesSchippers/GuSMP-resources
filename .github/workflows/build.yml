# Automatically build the project and run any configured tests for every push
# and submitted pull request. This can help catch issues that only occur on
# certain platforms or Java versions, and provides a first line of defence
# against bad commits.

name: build
on:
  pull_request:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      owo-lib-hash: ${{ steps.owo-lib-commit.outputs.hash }}
      accessories-hash: ${{ steps.accessories-commit.outputs.hash }}
    steps:
      - name: checkout owo-lib
        uses: actions/checkout@v4
        with:
          repository: GillesSchippers/owo-lib
          path: owo-lib

      - name: checkout accessories
        uses: actions/checkout@v4
        with:
          repository: GillesSchippers/accessories
          path: accessories

      - name: Get owo-lib commit hash
        id: owo-lib-commit
        working-directory: owo-lib
        run: echo "hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Get accessories commit hash
        id: accessories-commit
        working-directory: accessories
        run: echo "hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

  build-owo-lib:
    runs-on: ubuntu-22.04
    needs: setup
    strategy:
      matrix:
        java: [21]
    steps:
      - name: checkout owo-lib
        uses: actions/checkout@v4
        with:
          repository: GillesSchippers/owo-lib
          path: owo-lib

      - name: setup jdk ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: gradle

      - name: Cache owo-lib build
        id: cache-owo-lib
        uses: actions/cache/restore@v4
        with:
          path: |
            owo-lib/build
            ~/.m2/repository/io/wispforest/owo-lib
          key: owo-lib-build-${{ runner.os }}-${{ needs.setup.outputs.owo-lib-hash }}

      - name: publish owo-lib to Maven Local
        if: steps.cache-owo-lib.outputs.cache-hit != 'true'
        working-directory: owo-lib
        run: |
          chmod +x gradlew
          ./gradlew publishToMavenLocal --no-daemon

      - name: Save owo-lib cache
        if: steps.cache-owo-lib.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            owo-lib/build
            ~/.m2/repository/io/wispforest/owo-lib
          key: owo-lib-build-${{ runner.os }}-${{ needs.setup.outputs.owo-lib-hash }}

      - name: Upload owo-lib Maven artifacts
        uses: actions/upload-artifact@v4
        with:
          name: owo-lib-maven
          path: ~/.m2/repository/io/wispforest/owo-lib
          retention-days: 1

      - name: Upload owo-lib build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: owo-lib-build
          path: owo-lib/build/libs/
          retention-days: 1

  build-accessories:
    runs-on: ubuntu-22.04
    needs: [setup, build-owo-lib]
    strategy:
      matrix:
        java: [21]
    steps:
      - name: checkout accessories
        uses: actions/checkout@v4
        with:
          repository: GillesSchippers/accessories
          path: accessories

      - name: setup jdk ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: gradle

      - name: Download owo-lib Maven artifacts
        uses: actions/download-artifact@v4
        with:
          name: owo-lib-maven
          path: ~/.m2/repository/io/wispforest/owo-lib

      - name: Cache accessories build
        id: cache-accessories
        uses: actions/cache/restore@v4
        with:
          path: |
            accessories/fabric/build
            ~/.m2/repository/io/wispforest/accessories-fabric
          key: accessories-build-${{ runner.os }}-${{ needs.setup.outputs.accessories-hash }}

      - name: publish accessories to Maven Local
        if: steps.cache-accessories.outputs.cache-hit != 'true'
        working-directory: accessories
        run: |
          chmod +x gradlew
          ./gradlew publishToMavenLocal --no-daemon

      - name: Save accessories cache
        if: steps.cache-accessories.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            accessories/fabric/build
            ~/.m2/repository/io/wispforest/accessories-fabric
          key: accessories-build-${{ runner.os }}-${{ needs.setup.outputs.accessories-hash }}

      - name: Upload accessories Maven artifacts
        uses: actions/upload-artifact@v4
        with:
          name: accessories-maven
          path: ~/.m2/repository/io/wispforest/accessories-fabric
          retention-days: 1

      - name: Upload accessories build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: accessories-build
          path: accessories/fabric/build/libs/
          retention-days: 1

  build-gustavdev:
    runs-on: ubuntu-22.04
    needs: [build-owo-lib, build-accessories]
    strategy:
      matrix:
        java: [21]
        os: [ubuntu-22.04]
    steps:
      - name: checkout gustavdev
        uses: actions/checkout@v4
        with:
          path: gustavdev

      - name: setup jdk ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: gradle

      - name: Download owo-lib Maven artifacts
        uses: actions/download-artifact@v4
        with:
          name: owo-lib-maven
          path: ~/.m2/repository/io/wispforest/owo-lib

      - name: Download accessories Maven artifacts
        uses: actions/download-artifact@v4
        with:
          name: accessories-maven
          path: ~/.m2/repository/io/wispforest/accessories-fabric

      - name: Verify Maven Local contents
        run: |
          echo "Maven Local contents:"
          ls -la ~/.m2/repository/io/wispforest/ || echo "Directory not found"
          echo "owo-lib:"
          find ~/.m2/repository/io/wispforest/owo-lib -type f 2>/dev/null || echo "Not found"
          echo "accessories-fabric:"
          find ~/.m2/repository/io/wispforest/accessories-fabric -type f 2>/dev/null || echo "Not found"

      - name: build gustavdev
        working-directory: gustavdev
        run: |
          chmod +x gradlew
          ./gradlew build --no-daemon

      - name: Upload gustavdev artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gustavdev-build-java-${{ matrix.java }}
          path: gustavdev/build/libs/
          retention-days: 7

  collect-artifacts:
    runs-on: ubuntu-22.04
    needs: [build-gustavdev]
    if: always() && needs.build-gustavdev.result == 'success'
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-build'
          path: artifacts
          merge-multiple: false

      - name: Create combined artifact archive
        run: |
          mkdir -p combined-artifacts/gustavdev
          mkdir -p combined-artifacts/dependencies/owo-lib
          mkdir -p combined-artifacts/dependencies/accessories
          
          # Copy gustavdev artifacts
          if [ -d "artifacts/gustavdev-build-java-21" ]; then
            cp -r artifacts/gustavdev-build-java-21/* combined-artifacts/gustavdev/ || true
          fi
          
          # Copy dependency artifacts
          if [ -d "artifacts/owo-lib-build" ]; then
            cp -r artifacts/owo-lib-build/* combined-artifacts/dependencies/owo-lib/ 2>/dev/null || true
          fi
          
          if [ -d "artifacts/accessories-build" ]; then
            cp -r artifacts/accessories-build/* combined-artifacts/dependencies/accessories/ 2>/dev/null || true
          fi

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-build-artifacts
          path: combined-artifacts/
          retention-days: 30

      - name: Generate artifact summary
        run: |
          echo "## Build Artifacts Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GustavDev" >> $GITHUB_STEP_SUMMARY
          find combined-artifacts/gustavdev -type f -name "*.jar" -exec basename {} \; 2>/dev/null | while read jar; do
            echo "- \`$jar\`" >> $GITHUB_STEP_SUMMARY
          done || echo "- No artifacts found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "#### owo-lib" >> $GITHUB_STEP_SUMMARY
          find combined-artifacts/dependencies/owo-lib -type f -name "*.jar" -exec basename {} \; 2>/dev/null | while read jar; do
            echo "- \`$jar\`" >> $GITHUB_STEP_SUMMARY
          done || echo "- No artifacts found" >> $GITHUB_STEP_SUMMARY
          echo "#### accessories" >> $GITHUB_STEP_SUMMARY
          find combined-artifacts/dependencies/accessories -type f -name "*.jar" -exec basename {} \; 2>/dev/null | while read jar; do
            echo "- \`$jar\`" >> $GITHUB_STEP_SUMMARY
          done || echo "- No artifacts found" >> $GITHUB_STEP_SUMMARY
