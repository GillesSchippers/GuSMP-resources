# Automatically build the project and run any configured tests for every push
# and submitted pull request. This can help catch issues that only occur on
# certain platforms or Java versions, and provides a first line of defence
# against bad commits.

name: build

on:
  pull_request:
  workflow_dispatch:
  push:
    branches: 
    - master

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        java: [21]
        os: [ubuntu-22.04]

    steps:
      - name: checkout gustavdev
        uses: actions/checkout@v6
        with:
          path: gustavdev

      - name: checkout accessories
        uses: actions/checkout@v6
        with:
          repository: GillesSchippers/accessories
          path: accessories

      - name: checkout owo-lib
        uses: actions/checkout@v6
        with:
          repository: GillesSchippers/owo-lib
          path: owo-lib

      - name: setup jdk ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: gradle

      # Caching Strategy:
      # - Cache owo-lib, accessories, and aerialhell builds based on their commit hashes
      # - When cache hits, skip expensive build/publish steps
      # - Caches both build outputs and Maven Local artifacts
      # - Gradle dependencies are cached by setup-java action above
      
      - name: Get owo-lib commit hash
        id: owo-lib-commit
        working-directory: owo-lib
        run: echo "hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Get accessories commit hash
        id: accessories-commit
        working-directory: accessories
        run: echo "hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Cache owo-lib build
        id: cache-owo-lib
        uses: actions/cache/restore@v5
        with:
          path: |
            owo-lib/build
            ~/.m2/repository/io/wispforest/owo-lib
          key: owo-lib-build-${{ runner.os }}-${{ steps.owo-lib-commit.outputs.hash }}

      - name: Cache accessories build
        id: cache-accessories
        uses: actions/cache/restore@v5
        with:
          path: |
            accessories/fabric/build
            ~/.m2/repository/io/wispforest/accessories-fabric
          key: accessories-build-${{ runner.os }}-${{ steps.accessories-commit.outputs.hash }}

      - name: publish owo-lib to Maven Local
        if: steps.cache-owo-lib.outputs.cache-hit != 'true'
        working-directory: owo-lib
        run: |
          chmod +x gradlew
          ./gradlew publishToMavenLocal --no-daemon

      - name: Save owo-lib cache
        if: steps.cache-owo-lib.outputs.cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          path: |
            owo-lib/build
            ~/.m2/repository/io/wispforest/owo-lib
          key: owo-lib-build-${{ runner.os }}-${{ steps.owo-lib-commit.outputs.hash }}

      - name: publish accessories to Maven Local
        if: steps.cache-accessories.outputs.cache-hit != 'true'
        working-directory: accessories
        run: |
          chmod +x gradlew
          ./gradlew publishToMavenLocal --no-daemon

      - name: Save accessories cache
        if: steps.cache-accessories.outputs.cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          path: |
            accessories/fabric/build
            ~/.m2/repository/io/wispforest/accessories-fabric
          key: accessories-build-${{ runner.os }}-${{ steps.accessories-commit.outputs.hash }}

      - name: build gustavdev
        working-directory: gustavdev
        run: |
          chmod +x gradlew
          ./gradlew build --no-daemon

      - name: capture gustavdev artifacts
        if: runner.os == 'Linux' && matrix.java == '21'
        uses: actions/upload-artifact@v4
        with:
          name: gustavdev-artifacts
          path: "**/build/libs/"
